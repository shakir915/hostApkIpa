<!DOCTYPE html>
<html lang="en">


<!---------------------------uv7----------------------------->
<!-------------------------------------------------------->
<!-------------------------------------------------------->
<!-------------------------------------------------------->
<!-------------------------------------------------------->
<!--  git clone https://github.com/shakir915/hostApkIpa -->
<!-------------------------------------------------------->
<!-------------------------------------------------------->
<!-------------------------------------------------------->
<!-------------------------------------------------------->
<!-------------------------------------------------------->


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <title>Upload IPA,APK</title>

  <!-- update the version number as needed -->
  <script defer src="/__/firebase/9.15.0/firebase-app-compat.js"></script>
  <!-- include only the Firebase features as you need -->
  <!--    <script defer src="/__/firebase/9.15.0/firebase-auth-compat.js"></script>-->
  <script defer src="/__/firebase/9.15.0/firebase-database-compat.js"></script>
  <!--    <script defer src="/__/firebase/9.15.0/firebase-firestore-compat.js"></script>-->
  <!--    <script defer src="/__/firebase/9.15.0/firebase-functions-compat.js"></script>-->
  <!--    <script defer src="/__/firebase/9.15.0/firebase-messaging-compat.js"></script>-->
  <script defer src="/__/firebase/9.15.0/firebase-storage-compat.js"></script>
  <script defer src="/__/firebase/9.15.0/firebase-analytics-compat.js"></script>
  <!--    <script defer src="/__/firebase/9.15.0/firebase-remote-config-compat.js"></script>-->
  <!--    <script defer src="/__/firebase/9.15.0/firebase-performance-compat.js"></script>-->
  <!--
    initialize the SDK after all desired features are loaded, set useEmulator to false
    to avoid connecting the SDK to running emulators.
  -->
  <script defer src="/__/firebase/init.js?useEmulator=true"></script>





  <style>
    html,
    body {
      padding: 0;
      margin: 0;
      font-size: 12px;
      background: #efefef;
    }

    p {
      padding: 0;
      margin: 0;
    }

    .container {
      width: 450px;
      margin: auto;
      padding-top: 20px;
      padding-bottom: 20px;
    }


    h1 {
      text-align: center;
      margin: auto;
      padding-top: 20px;
      padding-bottom: 20px;
      font-family: Georgia, serif;
    }


    .title {
      border-left: 4px solid #78C3F3;
      padding-left: 0px;
      font-size: 16px;
      margin: 0 0 20px 0;
    }

    .card {
      padding: 20px;
      margin-bottom: 20px;
      background: #fff;
      border-radius: 4px;
      font-size: 12px;
      transition: all .3s;
      border: 1px solid #d9d9d9;
      border-color: #e9e9e9;
    }

    .card:hover {
      box-shadow: 0 1px 6px hsla(0, 0%, 39%, .2);
      border-color: #eee;
    }

    .file {
      position: relative;
      border: 1px solid #99D3F5;
      border-radius: 2px;
      width: 85px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      color: #1E88C7;
    }

    .file:hover {
      background: #AADFFD;
      border-color: #78C3F3;
      color: #004974;
      text-decoration: none;
    }

    #file-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 85px;
      height: 30px;
      opacity: 0;
    }

    #file-input:hover {
      cursor: pointer;
    }




    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 140px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 150%;
      left: 50%;
      margin-left: -75px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #555 transparent transparent transparent;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }


    .drop-zone {

      height: 300px;
      width: 300px;
      margin: auto;
      padding: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-family: "Quicksand", sans-serif;
      font-weight: 500;
      font-size: 20px;
      cursor: pointer;
      color: #cccccc;
      border: 4px dashed #009578;
      border-radius: 10px;
    }

    .drop-zone--over {
      border-style: solid;
    }

    .drop-zone__input {
      display: none;
    }

    .drop-zone__thumb {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      overflow: hidden;
      background-color: #cccccc;
      background-size: cover;
      position: relative;
    }

    .drop-zone__thumb::after {
      content: attr(data-label);
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 5px 0;
      color: #ffffff;
      background: rgba(0, 0, 0, 0.75);
      font-size: 14px;
      text-align: center;
    }

    span.login-text {
      font-size: 10px;
      display: table;
      align-items: center;
      text-align: center;
      margin-left: auto;
      margin-right: auto;
    }

    a.uploadNewApp {
      font-size: 12px;
      display: table;
      align-items: center;
      text-align: center;
      margin-left: auto;
      margin-right: auto;
      text-decoration: none;
      visibility: hidden;
      cursor: pointer;
    }






    form.formClass {
  font-size: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  margin-left: auto;
  margin-right: auto;
  gap: 10px;
}

/* Ensure multiple radio buttons fit in one line if thereâ€™s space */
.radioContainer {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
}

/* Keep each radio + label together */
.radioOption {
  display: flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
}





  </style>
</head>

<body>
  <div class="container">


    <h1>Upload APK, IPA</h1>

    <div id="topContainer" class="drop-zone">
      <span class="drop-zone__prompt">Drop ipa/apk here <br />or click to select a file</span>
      <input id="file-input" type="file" name="myFile" class="drop-zone__input">
    </div>




    <div id="result-list">
    </div>
  </div>
  <div>
    <span class="login-text" style="color: #f00;opacity: 1;  font-weight: 600; " id="failText"></span>





    <a  class="uploadNewApp" id="uploadNewApp" target="_blank"
      style="color: #00f;opacity: 1;  font-weight: 600; ">Upload another App</a>
    <br />

    <script type="text/javascript">


async function refreshRedirection() {
  const response = await fetch("https://install4-default-rtdb.asia-southeast1.firebasedatabase.app/redirection.json");
  const new_redirection = await response.json();
  console.log(new_redirection);
  var old_redirection=localStorage.getItem('redirection');
  localStorage.setItem('redirection',new_redirection);





  if(new_redirection!=null&&new_redirection.trim!=""&& !window.location.href.includes("g_url_id") &&  !window.location.href.includes("localhost") && window.location.href!=new_redirection ){
    window.location = new_redirection;
}

}


refreshRedirection();


      document.getElementById("uploadNewApp").onclick = function () {
        var redirection=localStorage.getItem('redirection');
        window.open(redirection, '_blank');
      };
  </script>


    
    <span class="login-text" style="color: #000;opacity: 1;  font-weight: 200; ">
      This website uses Firebase free tier, which has a bandwidth limit of 1 GB per day.<br />Download links may not work if the website exceeds the limit.
    </span>
    <br />

    <span class="login-text" style="color: #000;opacity: .5;  font-weight: 600; " id="siteAndDevName"></span>
    <br />

    <!-- <a href="https://github.com/shakir915/hostApkIpa" class="uploadNewApp" id="uploadNewApp" target="_blank"
    style="color: rgb(56, 56, 193);opacity: .5;  font-weight: 300; visibility: visible;">source code @ github</a>
  <br /> -->



  </div>
  <script src="./app-info-parser-1/dist/app-info-parser.js"></script>
  <script>






    function get_incoming_g_url_id() {
      const queryString = window.location.search;
      console.log(queryString);
      const urlParams = new URLSearchParams(queryString);
      const incoming_g_url_id = urlParams.get('g_url_id')
      console.log(incoming_g_url_id);
      if(incoming_g_url_id!="new"&&incoming_g_url_id != null && incoming_g_url_id.trim() != "")
        return incoming_g_url_id;
      else   return null;
    }
    const incoming_g_url_id = get_incoming_g_url_id();







    // const siteAndDevName = document.querySelector('#siteAndDevName');
    // siteAndDevName.textContent = window.location.hostname + " by Shakir ";


    document.querySelectorAll(".drop-zone__input").forEach((inputElement) => {
      const dropZoneElement = inputElement.closest(".drop-zone");

      dropZoneElement.addEventListener("click", (e) => {
        inputElement.click();
      });

      inputElement.addEventListener("change", (e) => {
        if (inputElement.files.length) {
          updateThumbnail(dropZoneElement, inputElement.files[0]);

        }
      });

      dropZoneElement.addEventListener("dragover", (e) => {
        e.preventDefault();
              dropZoneElement.classList.add("drop-zone--over");
      });

      ["dragleave", "dragend"].forEach((type) => {
        dropZoneElement.addEventListener(type, (e) => {
          dropZoneElement.classList.remove("drop-zone--over");
        });
      });

      dropZoneElement.addEventListener("drop", (e) => {
        e.preventDefault();

        if (e.dataTransfer.files.length) {
          inputElement.files = e.dataTransfer.files;
          updateThumbnail(dropZoneElement, e.dataTransfer.files[0]);
        }

        dropZoneElement.classList.remove("drop-zone--over");
      });
    });

    /**
     * Updates the thumbnail on a drop zone element.
     *
     * @param {HTMLElement} dropZoneElement
     * @param {File} file
     */
    function updateThumbnail(dropZoneElement, file) {

      fileSelect()
      return

      let thumbnailElement = dropZoneElement.querySelector(".drop-zone__thumb");

      // First time - remove the prompt
      if (dropZoneElement.querySelector(".drop-zone__prompt")) {
        dropZoneElement.querySelector(".drop-zone__prompt").remove();
      }

      // First time - there is no thumbnail element, so lets create it
      if (!thumbnailElement) {
        thumbnailElement = document.createElement("div");
        thumbnailElement.classList.add("drop-zone__thumb");
        dropZoneElement.appendChild(thumbnailElement);
      }

      thumbnailElement.dataset.label = file.name;

      // Show thumbnail for image files
      if (file.type.startsWith("image/")) {
        const reader = new FileReader();

        reader.readAsDataURL(file);
        reader.onload = () => {
          thumbnailElement.style.backgroundImage = `url('${reader.result}')`;
        };
      } else {
        thumbnailElement.style.backgroundImage = null;
      }


    }








function setGURLID() {
    const selectedRadio = document.querySelector('input[name="appEnvironment"]:checked');

    if (selectedRadio) {
        if (selectedRadio.id === "appName") {
            g_url_id = g_app_name_for_url;
        } else if (selectedRadio.id === "appNameQa") {
           g_url_id = g_app_name_for_url+"_qa";
        } else if (selectedRadio.id === "appNameProd") {
             g_url_id = g_app_name_for_url+"_prod";
        }  else if (selectedRadio.id === "appNameBeta") {
             g_url_id = g_app_name_for_url+"_beta";
        }  else if (selectedRadio.id === "appNameAlpha") {
             g_url_id = g_app_name_for_url+"_alpha";
        }   else if (selectedRadio.id === "appNameLounge") {
             g_url_id = g_app_name_for_url+"_lounge";
        }  else if (selectedRadio.id === "appNameStaging") {
             g_url_id = g_app_name_for_url+"_staging";
        } else if (selectedRadio.id === "Random") {
             g_url_id = g_url_id_random
        } else {
            console.log("Unknown selection");
        }


    } else {
        console.log("No option selected");
    }



}


function setGURLIDSubmit() {
    const selectedRadio = document.querySelector('input[name="appEnvironment"]:checked');

    if (selectedRadio) {
        if(is_apk_plist_done){
          on_apk_plist_upload();
        }

    } else {
        console.log("No option selected");
    }



}



    function copy_to_clipboard() {

      var url = "https://" + window.location.hostname + "/" + g_url_id
      navigator.clipboard.writeText(url);

      var tooltip = document.getElementById("myTooltip");
      tooltip.innerHTML = "Copied: " + url;
    }

    function copy_to_clipboard_show() {
      var tooltip = document.getElementById("myTooltip");
      tooltip.innerHTML = "Copy to clipboard";
    }




    var g_file = null;
    var g_version = null;
    var package_bundle_id = null;
    var g_url_id = null;
    var g_url_id_random = null;
    var g_ipa_url = null;
    var g_plist_url = null;
    var g_apk_url = null;
    var g_app_name = null;
    var g_app_name_for_url = null;
    var g_app_icon = null;
    var isIos = null;
    var g_result = null;
    var pd_zero_accept = false;
    var is_apk_plist_done = false;
    var readableTime = Date(Date.now()).toLocaleString();

    var delete1 = null;
    var delete2 = null;



    function fileSelect() {
      var date = new Date(Date.now());
      readableTime = `${date.getFullYear()}_${(date.getMonth()+1).toString().padStart(2, '0')}_${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}${date.getSeconds().toString().padStart(2, '0')}`;

      const failText = document.querySelector('#failText');
      failText.textContent = ""

      const files = document.getElementById('file-input').files
      try {
        g_file = files[0];
        const parser = new AppInfoParser(g_file)
        parser.parse().then(result => {
          g_result = result

          g_version = result['versionName'] || result['CFBundleShortVersionString']
          package_bundle_id = result['package'] || result['CFBundleIdentifier']
          isIos = result['package'] == null && result['CFBundleIdentifier'] != null
          if (isIos) {
            g_app_name = result['CFBundleDisplayName']
            if (g_app_name == null) {
              g_app_name = result['CFBundleName']
            }
            if (g_app_name == null) {
              g_app_name = result['CFBundleExecutable']
            }
          }
          else {
            if (Array.isArray(result['application']['label']))
              g_app_name = result['application']['label'][0]
            else
              g_app_name = result['application']['label']
          }

          g_app_name_for_url=appNameForUrl(g_app_name)

          g_app_icon = result.icon

          const div = document.createElement('div')



          document.getElementById("topContainer").style.display = "none";

          div.innerHTML = `
            <div style="padding: 20px; margin-bottom: 10px; background: #fff; border-radius: 4px; font-size: 16px; color: #717171; border: 1px solid #d9d9d9; border-color: #e9e9e9;">
              <p style="padding: 10px 0; display: flex; overflow: hidden;">
                <span style="color: #000; text-align: right; width: 100px; font-weight: 600; padding-right: 20px;">File Name: </span>
                <span style="width: 0; flex: 1; overflow-wrap: break-word; word-wrap: break-word;">${files[0].name}</span>
              </p>
              <p style="padding: 10px 0; display: flex; overflow: hidden;">
                <span style="color: #000; text-align: right; width: 100px; font-weight: 600; padding-right: 20px;">App Icon: </span>
                <img style="width: 80px; height: 80px;" src="${g_app_icon}" alt="">
                <span style="color: blue; text-align: right; width: 100px; font-weight: 600; padding-right: 20px;" onclick="viewJsonInNewTab()"  >More Info</span>
              </p>
              <p style="padding: 10px 0; display: flex; overflow: hidden;">
                <span style="color: #000; text-align: right; width: 100px; font-weight: 600; padding-right: 20px;">App Name: </span>
                <span style="width: 0; flex: 1; overflow-wrap: break-word; word-wrap: break-word;">${g_app_name}</span>
              </p>
              <p style="padding: 10px 0; display: flex; overflow: hidden;">
                <span style="color: #000; text-align: right; width: 100px; font-weight: 600; padding-right: 20px;">App Version: </span>
                <span style="width: 0; flex: 1; overflow-wrap: break-word; word-wrap: break-word;">${g_version}</span>
              </p>

              <p style="padding: 10px 0; display: flex; overflow: hidden;">
                <span style="color: #000; text-align: right; width: 100px; font-weight: 600; padding-right: 20px;">Bundle ID / App ID: </span>
                <span style="width: 0; flex: 1; overflow-wrap: break-word; word-wrap: break-word;">${package_bundle_id}</span>
              </p>



              <p style="padding: 10px 0; display: flex; overflow: hidden;">
                <span style="color: #000; text-align: right; width: 100px; font-weight: 600; padding-right: 20px;">Uploading: </span>
                <span id="uploadpercentage" style="width: 0; flex: 1; overflow-wrap: break-word; word-wrap: break-word;">0%</span>
              </p>








              <p >

                <div class="tooltip" style="padding: 10px 0; display: flex; overflow: hidden;">
                  <span style="color: #000; text-align: right; width: 100px; font-weight: 600; padding-right: 20px;">URL: </span>
                <span id="url_id_text" style="width: 0; flex: 1; overflow-wrap: break-word; word-wrap: break-word;"></span>
<button id="copy_button" onclick="copy_to_clipboard()" onmouseout="copy_to_clipboard_show()">
  <span class="tooltiptext" id="myTooltip">Copy to clipboard</span>
  Copy
  </button>
</div>

              </p>



<form class="formClass" id="radioForms">
  <div class="radioContainer">

    <div class="radioOption">
      <input type="radio" id="appName" name="appEnvironment" value="appName" onclick="setGURLID()">
      <label for="appName">${g_app_name_for_url}</label>
    </div>

    <div class="radioOption">
      <input type="radio" id="appNameQa" name="appEnvironment" value="appNameQa" onclick="setGURLID()">
      <label for="appNameQa">${g_app_name_for_url}_qa</label>
    </div>

    <div class="radioOption">
      <input type="radio" id="appNameProd" name="appEnvironment" value="appNameProd" onclick="setGURLID()">
      <label for="appNameProd">${g_app_name_for_url}_prod</label>
    </div>

<!--    <div class="radioOption">
      <input type="radio" id="appNameBeta" name="appEnvironment" value="appNameBeta" onclick="setGURLID()">
      <label for="appNameBeta">${g_app_name_for_url}_beta</label>
    </div>

    <div class="radioOption">
      <input type="radio" id="appNameAlpha" name="appEnvironment" value="appNameAlpha" onclick="setGURLID()">
      <label for="appNameAlpha">${g_app_name_for_url}_alpha</label>
    </div>

    <div class="radioOption">
      <input type="radio" id="appNameLounge" name="appEnvironment" value="appNameLounge" onclick="setGURLID()">
      <label for="appNameLounge">${g_app_name_for_url}_lounge</label>
    </div>

    <div class="radioOption">
      <input type="radio" id="appNameStaging" name="appEnvironment" value="appNameStaging" onclick="setGURLID()">
      <label for="appNameStaging">${g_app_name_for_url}_staging</label>
    </div>-->

    <div class="radioOption">
      <input type="radio" id="Random" name="appEnvironment" value="Random" onclick="setGURLID()">
      <label for="Random">Random</label>
    </div>

  </div>

  <button type="button" id="radioSubmitBtn" onclick="setGURLIDSubmit()">Submit</button>

</form>







            </div>
          `
          document.getElementById('result-list').appendChild(div)
          document.getElementById("copy_button").hidden = true;
          document.getElementById("uploadNewApp").style.visibility = 'visible';





          if ( incoming_g_url_id !== null) {
            const radioForms = document.getElementById('radioForms');
            radioForms.style.display = 'none';
            pd_zero_accept = true
            g_url_id = incoming_g_url_id
            uploadToFirebaseStorage()
          } else {
            db_entry();
          }

















        }).catch(e => {
          console.log("Parse Error c1", e)

          const failText = document.querySelector('#failText');
          failText.textContent = "Parse Error 1 \n" + e

        })
      } catch (e) {
        console.log("Parse Error c2", e)
        const failText = document.querySelector('#failText');
        failText.textContent = "Parse Error 2 \n" + e
      }
    }



    function makeid(length) {
      var result = '';
      var characters = 'abcdfghjklmnpqrstvwxz0123456789';
      var charactersLength = characters.length;
      for (var i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
      }
      return result;
    }




    function db_entry() {

      var url_id = makeid(4);
      console.log(url_id);
      const url_id_text = document.querySelector('#url_id_text');


      firebase.database().ref("/app_links/" + url_id).get().then((snapshot) => {
        if (snapshot.exists()) {
          db_entry()
        } else {
          g_url_id = url_id
          g_url_id_random = url_id
          url_id_text.textContent = "";
          uploadToFirebaseStorage()
        }
      }).catch((error) => {
        console.error(error);
      });





    }

  

    function on_ipa_apk_upload(downloadURL) {
      if (isIos) {
        g_ipa_url = downloadURL;
        on_ipa_upload()
      } else {
        g_apk_url = downloadURL;
         const selectedRadio = document.querySelector('input[name="appEnvironment"]:checked');
            is_apk_plist_done=true
         if (selectedRadio|| incoming_g_url_id !== null) {
        on_apk_plist_upload();
        }
      }
    }



   async function on_apk_plist_upload() {


        const radioForms = document.getElementById('radioForms');
        radioForms.style.display = 'none';



              try {
    const dbRef = firebase.database().ref("/app_links_all/"+g_app_name_for_url+"/" + "__"+g_url_id+"__"+readableTime);
    await dbRef.set({
      "local_fileName": g_file.name.toString(),
      "name": g_app_name,
      "icon": g_app_icon,
      "packageName": package_bundle_id,
      "versionName": g_version,
      "plist": g_plist_url,
      "ipa": g_ipa_url,
      "apk": g_apk_url,
      "readableTime": readableTime,
      "date": Date.now(),
    });


  } catch (error) {
console.error("Error setting data:", error)
  }






        await assignPrevOtherPlatformValues()





      try {
    const dbRef = firebase.database().ref("/app_links/" + g_url_id);
    await dbRef.set({
      "local_fileName": g_file.name.toString(),
      "name": g_app_name,
      "icon": g_app_icon,
      "packageName": package_bundle_id,
      "versionName": g_version,
      "plist": g_plist_url,
      "ipa": g_ipa_url,
      "apk": g_apk_url,
      "readableTime": readableTime,
      "date": Date.now(),
    });

  } catch (error) {
  radioForms.style.display = 'block';
  return
  }



      const url_id_text = document.querySelector('#url_id_text');
      var link="https://" + window.location.hostname + "/" + g_url_id
      url_id_text.textContent = link;
      url_id_text.style.color = "blue";
      url_id_text.onclick=function() {
        window.open(link, '_blank');
        
      };
      document.getElementById("copy_button").hidden = false;
      document.getElementById("topContainer").style.display = "none";



      try {
        var ref = firebase.database().ref("/url_list/"+g_app_name_for_url)
        var newChildRef = ref.push();
        newChildRef.set(g_url_id);
      } catch (e) {
       console.error("Error setting data:", error)

      }
      
        try {await fetch(delete1, {   method: 'DELETE', headers: {    }});} catch (e) {}
        try {await fetch(delete2, {   method: 'DELETE', headers: {    }});} catch (e) {}


      try {

        var ref = firebase.database().ref("/events")
        var newChildRef = ref.push();
        newChildRef.set({
          "page": "upload",
          "time": Date.now(),
          "action": "upload",
          "incoming_g_url_id": incoming_g_url_id,
          "page_id": g_url_id,
          "isIos": isIos,
          "readableTime": readableTime,

        });
      } catch (e) {
        console.error(e);

      }

 try {

    var platfromName=isIos?"ios":"android";
    firebase.database().ref("/more_details/"+platfromName+"/" + g_url_id).set(JSON.stringify(g_result));
      } catch (e) {
        console.error(e);

      }




      console.log( "BUILD LINK : "+link)

    }


    function saveFileSizeToDB(fileSize){
      try {

      firebase.database().ref("/" + "fileSize").push(fileSize);
    } catch (e) {
        console.error(e);

      }
    }



    function storage_space_check() {
      var ref = firebase.storage().ref("");
      ref.listAll()

    }


  async function assignPrevOtherPlatformValues() {
    if (g_url_id != null) {
        try {
            const snapshot = await firebase.database().ref("/app_links/" + g_url_id).get();

            if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                    const childKey = childSnapshot.key;
                    const childData = childSnapshot.val();

                    if (g_apk_url==null&& childKey === "apk" && childData != null) g_apk_url = childData;
                    if (g_ipa_url ==null&& childKey === "ipa" && childData != null) g_ipa_url = childData;
                    if (g_plist_url==null&& childKey === "plist" && childData != null) g_plist_url = childData;

                    if (childKey === "apk" && childData != null && !isIos) delete2 = childData;
                    if (childKey === "ipa" && childData != null && isIos) delete1 = childData;
                    if (childKey === "plist" && childData != null && isIos) delete2 = childData;



                });


            } else {

            }
        } catch (error) {
            console.error("Error fetching data from Firebase:", error);
        }
    } else {

    }
}





    document.addEventListener('DOMContentLoaded', function () {

      try {
        var ref = firebase.database().ref("/events")
        var newChildRef = ref.push();
        newChildRef.set({
          "page": "upload",
          "time": Date.now(),
          "action": "open",
          "incoming_g_url_id": incoming_g_url_id,
          "readableTime": readableTime
        });
      } catch (e) {
        console.error(e);
      }

    })




function appNameForUrl(str) {
    return str
        .toLowerCase()             // Convert to lowercase
        .replace(/\s+/g, '_')       // Replace spaces with underscores
        .replace(/[^a-z0-9_]/g, ''); // Remove all non a-z, non-digits, except underscore
}





    function viewJsonInNewTab() {
    const jsonString = encodeURIComponent(JSON.stringify(g_result));
    localStorage.setItem("jsonStore", jsonString);

    const newTab = window.open(`more_info.html`, '_blank');
    if (newTab) {
        newTab.focus();
    } else {
        alert('Please allow popups for this site.');
    }

}



    function uploadToFirebaseStorage() {


      if (isIos && !pd_zero_accept) {
        var pd = 0
        try {
          pd=g_result["mobileProvision"]["ProvisionedDevices"].length
        } catch (error) {
          console.log(error)
        }
        console.log("pd"+pd)
        if (pd == 0) {
         if( confirm("Provisioned Devices : " + pd + ".\nNo UDID added.\nUplaod any way? ")){
          pd_zero_accept=true;
         }else{
          var redirection=localStorage.getItem('redirection');
          window.location = redirection;
          return
         }
        }
      }


  return new Promise((resolve, reject) => {
    const uploadpercentage = document.querySelector('#uploadpercentage');
    const extension1 = g_file.name.split('.').pop();
    var url= `https://firebasestorage.googleapis.com/v0/b/install5.appspot.com/o/${encodeURIComponent("appStorageV2"+"/"+g_app_name_for_url+"/"+g_app_name_for_url+"_"+readableTime+"."+extension1)}`
    const xhr = new XMLHttpRequest();
    xhr.upload.addEventListener('progress', (event) => {

      if (event.lengthComputable ) {
        const progress = (event.loaded / event.total) * 100;
    
          console.log('' + progress.toFixed(0)  + '% ');
          if(progress>=100){
              uploadpercentage.textContent = 'Done';
              saveFileSizeToDB(g_file.size)
          }else{
             uploadpercentage.textContent = '' + progress.toFixed(0) + '%';
          }

      }
    });

    xhr.addEventListener('load', () => {

      if (xhr.status >= 200 && xhr.status < 300) {
        const result = JSON.parse(xhr.responseText);
        const downloadUrl = `${url}?alt=media&token=${result.downloadTokens}`;
        const url_id_text = document.querySelector('#url_id_text');
        const selectedRadio = document.querySelector('input[name="appEnvironment"]:checked');
        if (selectedRadio || incoming_g_url_id !== null)
          url_id_text.textContent = "Preparing...";
        else
          url_id_text.textContent = "Please Select a URL Suffix and Submit...";
        on_ipa_apk_upload(downloadUrl)
        resolve(result);
      } else {
        const failText = document.querySelector('#failText');
        failText.textContent = "Upload Failed\n" + xhr.status
        reject(new Error(`Upload failed with status: ${xhr.status}`));
      }
    });

    xhr.addEventListener('error', () => {
      const failText = document.querySelector('#failText');
      failText.textContent = 'Network error occurred during upload'
      reject(new Error('Network error occurred during upload'));
    });

    xhr.addEventListener('abort', () => {
      const failText = document.querySelector('#failText');
      failText.textContent = 'Upload aborted'
      reject(new Error('Upload aborted'));
    });

    xhr.open('POST', `${url}?uploadType=media`, true);
    xhr.setRequestHeader('Content-Type', 'application/vnd.android.package-archive');
    xhr.send(g_file);
  });
}




async function on_ipa_upload() {
      var plistContent =
        `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>items</key>
  <array>
    <dict>
      <key>assets</key>
      <array>
        <dict>
          <key>kind</key>
          <string>software-package</string>
          <key>url</key>
          <string><![CDATA[YOUR_IPA_URL_HERE]]></string>
        </dict>
      </array>
      <key>metadata</key>
      <dict>
        <key>bundle-identifier</key>
        <string>YOUR_IPA_BUNDLE_ID_HERE</string>
        <key>bundle-version</key>
        <string>YOUR_VERSION_HERE</string>
        <key>kind</key>
        <string>software</string>
        <key>title</key>
        <string>YOUR_IPA_APP_NAME_HERE</string>
        <key>subtitle</key>
        <string></string>
      </dict>
    </dict>
  </array>
</dict>
</plist>`
      plistContent = plistContent.replace("YOUR_IPA_URL_HERE", g_ipa_url)
        .replace("YOUR_VERSION_HERE", g_version)
        .replace("YOUR_IPA_BUNDLE_ID_HERE", package_bundle_id)
        .replace("YOUR_IPA_APP_NAME_HERE", g_app_name)


        if(true){

         
          var url= `https://firebasestorage.googleapis.com/v0/b/install5.appspot.com/o/${encodeURIComponent("appStorageV2"+"/"+g_app_name_for_url+"/"+g_app_name_for_url+"_"+readableTime+"_manifest"+".plist")}`
    
  const headers = {
    'Content-Type': 'application/xml',
  };


  const response = await fetch(url, {
    method: 'POST',
    headers,
    body: plistContent,
  });

  const result = await response.json();

  if (result.error) {
    const failText = document.querySelector('#failText');
    failText.textContent = "Upload Failed\n" + result.error
    console.error("Upload failed:", result.error);
    return;
  }

  const downloadUrl = `${url}?alt=media`;

  console.log('File available at', downloadUrl);
  g_plist_url = downloadUrl;
  is_apk_plist_done = true;

  const selectedRadio = document.querySelector('input[name="appEnvironment"]:checked');
  if (selectedRadio || incoming_g_url_id !== null) {
    on_apk_plist_upload();
  }

        }


    }


  </script>
</body>

</html>