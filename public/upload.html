<!DOCTYPE html>
<html lang="en">


<!-------------------------------------------------------->
<!-------------------------------------------------------->
<!-------------------------------------------------------->
<!-------------------------------------------------------->
<!-------------------------------------------------------->
<!--  git clone https://github.com/shakir915/hostApkIpa -->
<!-------------------------------------------------------->
<!-------------------------------------------------------->
<!-------------------------------------------------------->
<!-------------------------------------------------------->
<!-------------------------------------------------------->


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <title>Upload IPA,APK</title>

  <!-- update the version number as needed -->
  <script defer src="/__/firebase/11.6.0/firebase-app-compat.js"></script>
  <!-- include only the Firebase features as you need -->
  <script defer src="/__/firebase/11.6.0/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/11.6.0/firebase-database-compat.js"></script>
  <!--    <script defer src="/__/firebase/9.15.0/firebase-firestore-compat.js"></script>-->
  <!--    <script defer src="/__/firebase/9.15.0/firebase-functions-compat.js"></script>-->
  <!--    <script defer src="/__/firebase/9.15.0/firebase-messaging-compat.js"></script>-->
  <!-- <script defer src="/__/firebase/11.6.0/firebase-storage-compat.js"></script> -->
  <script defer src="/__/firebase/11.6.0/firebase-analytics-compat.js"></script>
  <!--    <script defer src="/__/firebase/9.15.0/firebase-remote-config-compat.js"></script>-->
  <!--    <script defer src="/__/firebase/9.15.0/firebase-performance-compat.js"></script>-->
  <!--
    initialize the SDK after all desired features are loaded, set useEmulator to false
    to avoid connecting the SDK to running emulators.
  -->
  <script defer src="/__/firebase/init.js?useEmulator=true"></script>





  <style>
    html,
    body {
      padding: 0;
      margin: 0;
      font-size: 12px;
      background: #2B2D30;
    }

    p {
      padding: 0;
      margin: 0;
    }

    .container {
      width: 450px;
      margin: auto;
      padding-top: 20px;
      padding-bottom: 20px;
    }


    h1 {
      text-align: center;
      margin: auto;
      padding-top: 20px;
      padding-bottom: 20px;
      font-family: Georgia, serif;
      color: #fff;
    }

    h5 {
      text-align: center;
      margin: auto;
      padding-bottom: 20px;
      font-family:  serif;
      color: #fff;
    }



    .title {
      border-left: 4px solid #78C3F3;
      padding-left: 0px;
      font-size: 16px;
      margin: 0 0 20px 0;
    }

    .card {
      padding: 20px;
      margin-bottom: 20px;
      background: #fff;
      border-radius: 4px;
      font-size: 12px;
      transition: all .3s;
      border: 1px solid #d9d9d9;
      border-color: #e9e9e9;
    }

    .card:hover {
      box-shadow: 0 1px 6px hsla(0, 0%, 39%, .2);
      border-color: #eee;
    }

    .file {
      position: relative;
      border: 1px solid #99D3F5;
      border-radius: 2px;
      width: 85px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      color: #1E88C7;
    }

    .file:hover {
      background: #AADFFD;
      border-color: #78C3F3;
      color: #004974;
      text-decoration: none;
    }

    #file-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 85px;
      height: 30px;
      opacity: 0;
    }

    #file-input:hover {
      cursor: pointer;
    }




    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 140px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 150%;
      left: 50%;
      margin-left: -75px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #555 transparent transparent transparent;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }


    .drop-zone {

      height: 300px;
      width: 300px;
      margin: auto;
      padding: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-family: "Quicksand", sans-serif;
      font-weight: 500;
      font-size: 20px;
      cursor: pointer;
      color: #cccccc;
      border: 4px dashed #009578;
      border-radius: 10px;
    }

    .drop-zone--over {
      border-style: solid;
    }

    .drop-zone__input {
      display: none;
    }

    .drop-zone__thumb {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      overflow: hidden;
      background-color: #cccccc;
      background-size: cover;
      position: relative;
    }

    .drop-zone__thumb::after {
      content: attr(data-label);
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 5px 0;
      color: #ffffff;
      background: rgba(0, 0, 0, 0.75);
      font-size: 14px;
      text-align: center;
    }

    span.login-text {
      font-size: 10px;
      display: table;
      align-items: center;
      text-align: center;
      margin-left: auto;
      margin-right: auto;
    }

    a.uploadNewApp {
      font-size: 12px;
      display: table;
      align-items: center;
      text-align: center;
      margin-left: auto;
      margin-right: auto;
      text-decoration: none;
      visibility: hidden;
      cursor: pointer;
    }






    form.formClass {
      font-size: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      margin-left: auto;
      margin-right: auto;
      gap: 10px;
    }

    /* Ensure multiple radio buttons fit in one line if thereâ€™s space */
    .radioContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    /* Keep each radio + label together */
    .radioOption {
      display: flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }


    .inputWrapper {
      display: inline-block;
      position: relative;
    }

    #customInput {
      min-width: 10px;
      /* Reduced from 50px */
      font-size: 0.9em;
      /* Smaller font size */
      padding: 2px 4px;
      /* Reduced padding */
      border: 1px solid #ccc;
      border-radius: 3px;
      /* Slightly smaller border radius */
      width: auto;
    }

    #textSizer {
      visibility: hidden;
      white-space: pre;
      position: absolute;
      top: 0;
      left: 0;
      font-size: 0.9em;
      /* Match the input font size */
      padding: 2px 4px;
      /* Match the input padding */
    }
  </style>
</head>

<body>
  <div class="container">


    <div style="position: relative;">
      <a href="epoch_converter.html" target="_blank"
        style="font-size: 12px; color: rgb(209, 218, 197); opacity: .7; margin-left: 10px; text-decoration: none;">
        Epoch Timestamp Converter
      </a>
      <a href="string_converts.html" target="_blank"
        style="font-size: 12px; color: rgb(195, 181, 164); opacity: .7; margin-left: 10px; text-decoration: none;">
        Text/Base64/URL/Hash Tools
      </a>

      <a href="encryption.html" target="_blank"
        style="font-size: 12px; color: rgb(170, 170, 196); opacity: .7; margin-left: 10px; text-decoration: none;">
        String Encryption Tool
      </a>

      <a href="sqlite_viewer.html" target="_blank"
        style="font-size: 12px; color: rgb(241, 249, 193); opacity: .7; margin-left: 10px; text-decoration: none;">
        SQLite Viewer
      </a>

      <a href="qr-code-generator.html" target="_blank"
        style="font-size: 12px; color: rgb(216, 205, 254); opacity: .7; margin-left: 10px; text-decoration: none;">
        QR code generator
      </a>



      <a href="https://hexed.it/" target="_blank"
        style="font-size: 12px; color: rgb(255, 198, 198); opacity: .7; margin-left: 10px; text-decoration: none;">
        Hex Editor
      </a>

      <a href="file-transfer-app (2).html" target="_blank"
        style="font-size: 12px; color: rgb(216, 177, 211); opacity: .7; margin-left: 10px; text-decoration: none;">
        Local Network File Transfer er
      </a>

    </div>


    <h1>Upload APK, IPA</h1>
    <h5 id="availableSpace"> </h5>



    <div id="topContainer" class="drop-zone">
      <span class="drop-zone__prompt">
        Drop ipa/apk here <br />or click to select a file
      </span>
      <input id="file-input" type="file" name="myFile" class="drop-zone__input">
    </div>





    <div id="result-list">
    </div>
  </div>
  <div>
    <span class="login-text" style="color: #f00;opacity: 1;  font-weight: 600; " id="failText"></span>





    <a class="uploadNewApp" id="uploadNewApp" target="_blank"
      style="color:  rgb(193, 129, 56);opacity: 1;  font-weight: 600; ">Upload
      another App</a>
    <br />

    <script type="text/javascript">


      async function refreshRedirection() {
        if (window.location.href.includes("localhost") || window.location.href.startsWith("file:///")) {
          return; // Exit the function without fetching
        }
        const response = await fetch("https://install4-default-rtdb.asia-southeast1.firebasedatabase.app/redirection.json");
        const new_redirection = await response.json();
        //console.log(new_redirection);
        var old_redirection = localStorage.getItem('redirection');
        localStorage.setItem('redirection', new_redirection);
        if (new_redirection != null && new_redirection.trim != "" && !window.location.href.includes("g_url_id") && !window.location.href.includes("localhost") && window.location.href != new_redirection) {
          window.location = new_redirection;
        }

      }


      refreshRedirection();


      document.getElementById("uploadNewApp").onclick = function () {
        var redirection = localStorage.getItem('redirection');
        window.open(redirection, '_blank');
      };
    </script>



    <span class="login-text" style="color: #000; opacity: 1; font-weight: 100; font-size: 8px;"></span>

    <br />

    <span class="login-text" style="color: #000;opacity: .5;  font-weight: 600; " id="siteAndDevName"></span>
    <br />

    <!-- <a href="https://github.com/shakir915/hostApkIpa" class="uploadNewApp" id="uploadNewApp" target="_blank"
    style="color: rgb(56, 56, 193);opacity: .5;  font-weight: 300; visibility: visible;">source code @ github</a>
  <br /> -->



  </div>
  <script src="./app-info-parser-1/dist/app-info-parser.js"></script>
  <script>






    function get_incoming_g_url_id() {
      const queryString = window.location.search;
      //console.log(queryString);
      const urlParams = new URLSearchParams(queryString);
      const incoming_g_url_id = urlParams.get('g_url_id')
      //console.log(incoming_g_url_id);
      if (incoming_g_url_id != "new" && incoming_g_url_id != null && incoming_g_url_id.trim() != "")
        return incoming_g_url_id;
      else return null;
    }
    const incoming_g_url_id = get_incoming_g_url_id();
    var user = null;







    // const siteAndDevName = document.querySelector('#siteAndDevName');
    // siteAndDevName.textContent = window.location.hostname + " by Shakir ";


    document.querySelectorAll(".drop-zone__input").forEach((inputElement) => {
      const dropZoneElement = inputElement.closest(".drop-zone");

      dropZoneElement.addEventListener("click", (e) => {
        inputElement.click();
      });

      inputElement.addEventListener("change", (e) => {
        if (inputElement.files.length) {
          fileSelect()

        }
      });

      dropZoneElement.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZoneElement.classList.add("drop-zone--over");
      });

      ["dragleave", "dragend"].forEach((type) => {
        dropZoneElement.addEventListener(type, (e) => {
          dropZoneElement.classList.remove("drop-zone--over");
        });
      });

      dropZoneElement.addEventListener("drop", (e) => {
        e.preventDefault();

        if (e.dataTransfer.files.length) {
          inputElement.files = e.dataTransfer.files;
          fileSelect()
        }

        dropZoneElement.classList.remove("drop-zone--over");
      });
    });









    function setGURLID() {

    }


    function setGURLIDSubmit() {






    }



    function copy_to_clipboard() {
      var url = document.querySelector('#url_id_text').textContent
      navigator.clipboard.writeText(url);
      var tooltip = document.getElementById("myTooltip");
      tooltip.innerHTML = "Copied: " + url;
    }

    function copy_to_clipboard_show() {
      var tooltip = document.getElementById("myTooltip");
      tooltip.innerHTML = "Copy to clipboard";
    }




    var g_file = null;
    var g_version = null;
    var package_bundle_id = null;


    var g_ipa_url = null;
    var g_plist_url = null;
    var g_apk_url = null;
    var g_app_name = null;
    var g_app_name_for_url = null;
    var g_app_icon = null;
    var isIos = null;
    var g_result = null;
    var pd_zero_accept = false;
    var is_apk_plist_done = false;
    var readableTime = Date(Date.now()).toLocaleString();
    var g_bucket = null;





    async function fileSelect() {

      g_bucket = await findBestBucket();
      if (g_bucket == null) {
        const failText = document.querySelector('#failText');
        failText.textContent = "Storage not available; Please Delete old files"
        if (confirm("Storage not available; Please Delete old files")) {
          localStorage.setItem("hd_time", `${Date.now() + 60_000}`);
          const newTab = window.open(`more_info.html`, '_blank');
          newTab.focus();
        }
        return;
      }

      var date = new Date(Date.now());
      readableTime = `${date.getFullYear()}_${(date.getMonth() + 1).toString().padStart(2, '0')}_${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}${date.getSeconds().toString().padStart(2, '0')}`;

      const failText = document.querySelector('#failText');
      failText.textContent = ""

      const files = document.getElementById('file-input').files
      try {
        g_file = files[0];
        const parser = new AppInfoParser(g_file)
        parser.parse().then(async result => {
          g_result = result

          g_version = result['versionName'] || result['CFBundleShortVersionString']
          package_bundle_id = result['package'] || result['CFBundleIdentifier']
          isIos = result['package'] == null && result['CFBundleIdentifier'] != null
          if (isIos) {
            g_app_name = result['CFBundleDisplayName']
            if (g_app_name == null) {
              g_app_name = result['CFBundleName']
            }
            if (g_app_name == null) {
              g_app_name = result['CFBundleExecutable']
            }
          } else {
            if (Array.isArray(result['application']['label']))
              g_app_name = result['application']['label'][0]
            else
              g_app_name = result['application']['label']
          }

          g_app_name_for_url = appNameForUrl(g_app_name)

          g_app_icon = result.icon

          const div = document.createElement('div')
          document.getElementById("topContainer").style.display = "none";
          div.innerHTML = `
            <div style="padding: 20px; margin-bottom: 10px; background: #1E1F22; border-radius: 4px; font-size: 16px; color: #BCBEC3; border: 1px solid #fff; border-color: #222222;">
              <p style="padding: 10px 0; display: flex; overflow: hidden;">
                <span style="color: #C59172; text-align: right; width: 100px;  padding-right: 20px;">File Name: </span>
                <span style="width: 0; flex: 1; overflow-wrap: break-word; word-wrap: break-word;">${files[0].name}</span>
              </p>
              <p style="padding: 10px 0; display: flex; overflow: hidden;">
                <span style="color: #C59172; text-align: right; width: 100px;  padding-right: 20px;">App Icon: </span>
                <img style="width: 80px; height: 80px;" src="${g_app_icon}" alt="">
                <span style="color:  rgb(193, 129, 56); text-align: right; width: 100px;  padding-right: 20px;" onclick="viewJsonInNewTab()"  >More Info</span>
              </p>
              <p style="padding: 10px 0; display: flex; overflow: hidden;">
                <span style="color: #C59172; text-align: right; width: 100px;  padding-right: 20px;">App Name: </span>
                <span style="width: 0; flex: 1; overflow-wrap: break-word; word-wrap: break-word;">${g_app_name}</span>
              </p>
              <p style="padding: 10px 0; display: flex; overflow: hidden;">
                <span style="color: #C59172; text-align: right; width: 100px;  padding-right: 20px;">App Version: </span>
                <span style="width: 0; flex: 1; overflow-wrap: break-word; word-wrap: break-word;">${g_version}</span>
              </p>

              <p style="padding: 10px 0; display: flex; overflow: hidden;">
                <span style="color: #C59172; text-align: right; width: 100px;  padding-right: 20px;">Bundle ID / App ID: </span>
                <span style="width: 0; flex: 1; overflow-wrap: break-word; word-wrap: break-word;">${package_bundle_id}</span>
              </p>



              <p style="padding: 10px 0; display: flex; overflow: hidden;">
                <span style="color: #C59172; text-align: right; width: 100px;  padding-right: 20px;">Uploading: </span>
                <span id="uploadpercentage" style="width: 0; flex: 1; overflow-wrap: break-word; word-wrap: break-word;">0%</span>
              </p>








              <p >

                <div class="tooltip" style="padding: 10px 0; display: flex; overflow: hidden;">
                  <span style="color: #C59172; text-align: right; width: 100px;  padding-right: 20px;">URL: </span>
                <span id="url_id_text" style="width: 0; flex: 1; overflow-wrap: break-word; word-wrap: break-word;"></span>
<button id="copy_button" onclick="copy_to_clipboard()" onmouseout="copy_to_clipboard_show()">
  <span class="tooltiptext" id="myTooltip">Copy to clipboard</span>
  Copy
  </button>
</div>

              </p>



    <span id="max10URL" style="color: red; text-align: right; width: 100px; font-weight: 200; padding-right: 8px; font-size: 8px;"></span>
<form class="formClass" id="radioForms">
  <div class="radioContainer">
    <div id="dynamicRadioOptions" style="display: flex; align-items: center; flex-wrap: wrap;" ></div>
    <div class="radioOption" id="customOptionDIV" style="width: 150px;">
      <input type="radio" id="customOption" name="appEnvironment" value="custom" onclick="setGURLID()">
      <input type="text" id="customInput" value="${g_app_name_for_url}"  onkeypress="return restrictInput(event)"  onpaste="return sanitizePaste(event)"  />
        <button type="button" onclick="refreshCustomInput()" style="margin-left: 0px; padding: 0px; background: transparent; border: transparent;">
            <i class="fa fa-refresh" style="font-size:14px;color:#BCBEC3"></i>
          </button>
    </div>

  <button type="button" id="radioSubmitBtn" onclick="on_apk_plist_upload()">Submit</button>

</form>

            </div>
          `

          document.getElementById('result-list').appendChild(div)
          document.getElementById("copy_button").hidden = true;
          document.getElementById("uploadNewApp").style.visibility = 'visible';


          var url_list = "";
          try {
            var ref = firebase.database().ref("/url_list/" + g_app_name_for_url);
            const snapshot = await ref.once('value');
            url_list = snapshot.val();
            addDynamicRadioOptions(url_list)
          } catch (e) {
            console.error(e)
          }





          if ((incoming_g_url_id !== null && incoming_g_url_id !== undefined && String(incoming_g_url_id).trim() !== "")) {
            const radioForms = document.getElementById('radioForms');
            const max10URL = document.getElementById('max10URL');
            radioForms.style.display = 'none';
            max10URL.style.display = 'none';
            pd_zero_accept = true
          }

          uploadToFirebaseStorage()

        }).catch(e => {
          console.log("Parse Error c1", e)
          const failText = document.querySelector('#failText');
          failText.textContent = "Parse Error 1 \n" + e

        })
      } catch (e) {

        const failText = document.querySelector('#failText');
        failText.textContent = "" + e
      }
    }



    function makeid(length) {
      var result = '';
      var characters = 'abcdfghjklmnpqrstvwxz0123456789';
      var charactersLength = characters.length;
      for (var i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
      }
      return result;
    }








    async function on_ipa_apk_upload(downloadURL) {
      if (isIos) {
        g_ipa_url = downloadURL;
        on_ipa_upload()
      } else {
        g_apk_url = downloadURL;
        const selectedRadio = document.querySelector('input[name="appEnvironment"]:checked');
        is_apk_plist_done = true
        on_apk_plist_upload();
      }
    }


    function getUserId() {
      try {
        return user.uid
      } catch (e) {

      }
      return "random"
    }

    async function on_apk_plist_upload() {

      var g_url_id = null;
      if ((incoming_g_url_id !== null && incoming_g_url_id !== undefined && String(incoming_g_url_id).trim() !== "")) {
        g_url_id = incoming_g_url_id
      } else {

        const selectedRadio = document.querySelector('input[name="appEnvironment"]:checked');
        const customInput = document.getElementById('customInput');




        if (selectedRadio) {
          if (selectedRadio.value === "custom") {
            g_url_id = customInput.value
          } else {
            g_url_id = selectedRadio.value
          }
        } else {
          console.log("No option selected");
        }


        try {
          try {
            const apkHERE = (await (firebase.database().ref("/app_links/" + g_url_id + "/" + "android" + "/" + "apk")).once('value')).val();
            if (apkHERE.length > 0) {
              const g_app_name_for_url_HERE = (await (firebase.database().ref("/app_links/" + g_url_id + "/" + "android" + "/" + "g_app_name_for_url")).once('value')).val();
              if (g_app_name_for_url !== g_app_name_for_url_HERE) {
                alert(`URL ${g_url_id} Not Avaialble. Please Enter another URL Suffix`)
                g_url_id = null;
                return;
              }
            }
          } catch (e) {
          }

          try {
            const ipaHere = (await (firebase.database().ref("/app_links/" + g_url_id + "/" + "ios" + "/" + "ipa")).once('value')).val();
            if (ipaHere.length > 0) {
              const g_app_name_for_url_HERE = (await (firebase.database().ref("/app_links/" + g_url_id + "/" + "ios" + "/" + "g_app_name_for_url")).once('value')).val();
              if (g_app_name_for_url !== g_app_name_for_url_HERE) {
                alert(`URL ${g_url_id} Not Avaialble. Please Enter another URL Suffix`)
                g_url_id = null;
                return;
              }
            }
          } catch (e) {
          }
        } catch (e) {
        }

      }








      if ((is_apk_plist_done !== true) || g_url_id === null || g_url_id === undefined || g_url_id.trim() === "") {
        return //<<<<<<<<<<<<<<<<<<<<<<<<<<<<
      }



      const radioForms = document.getElementById('radioForms');
      const max10URL = document.getElementById('max10URL');
      radioForms.style.display = 'none';
      max10URL.style.display = 'none';
      var platfromName = isIos ? "ios" : "android";



      var nexwSet = {
        "local_fileName": g_file.name.toString(),
        "name": g_app_name,
        "platform": platfromName,
        "icon": g_app_icon,
        "packageName": package_bundle_id,
        "versionName": g_version,
        "plist": g_plist_url,
        "ipa": g_ipa_url,
        "apk": g_apk_url,
        "readableTime": readableTime,
        "date": Date.now(),
        "g_app_name_for_url": g_app_name_for_url,
        "g_url_id": g_url_id,
        "user_id": getUserId(),
      }

      try {
        const dbRef = firebase.database().ref("/app_links_all/" + g_app_name_for_url + "/" + "__" + g_url_id + "__" + readableTime + "/" + platfromName);
        await dbRef.set(nexwSet);
      } catch (error) {
        console.error("Error setting data:", error)
      }

      try {
        const dbRef = firebase.database().ref("/app_links/" + g_url_id + "/" + platfromName);
        await dbRef.set(nexwSet);
      } catch (error) {
        console.error("Error setting data:", error)
        radioForms.style.display = 'block';
        return
      }

      const url_id_text = document.querySelector('#url_id_text');
      var link = "https://" + window.location.hostname + "/" + g_url_id
      url_id_text.textContent = link;
      url_id_text.style.color = "rgb(193, 129, 56)";
      url_id_text.onclick = function () {
        window.open(link, '_blank');

      };

      document.getElementById("copy_button").hidden = false;
      document.getElementById("topContainer").style.display = "none";

      var url_list = "";
      try {
        var ref = firebase.database().ref("/url_list/" + g_app_name_for_url);
        const snapshot = await ref.once('value');
        url_list = snapshot.val();
      } catch (e) {
        console.error(e)
      }

      try {
        var ref = firebase.database().ref("/url_list/" + g_app_name_for_url);
        url_list = urlSuffixCommaSeperated(url_list, g_url_id)
        await ref.set(url_list);
      } catch (e) {
        console.error(e)
      }






      try {
        var ref = firebase.database().ref("/events")
        var newChildRef = ref.push();
        await newChildRef.set({
          "page": "upload",
          "time": Date.now(),
          "action": "upload",
          "incoming_g_url_id": incoming_g_url_id,
          "page_id": g_url_id,
          "isIos": isIos,
          "readableTime": readableTime,
        });
      } catch (e) {
        console.error(e);
      }

      //    try {await fetch(delete1, {   method: 'DELETE', headers: {    }});} catch (e) {}
      //    try {await fetch(delete2, {   method: 'DELETE', headers: {    }});} catch (e) {}

      try {
        await firebase.database().ref("/more_details/" + platfromName + "/" + g_url_id).set(JSON.stringify(g_result));
      } catch (e) {
        console.error(e);
      }


      console.log("BUILD LINK : " + link)

    }








    document.addEventListener('DOMContentLoaded', async function () {
      try {
        g_bucket = await findBestBucket();
        var ref = firebase.database().ref("/events")
        var newChildRef = ref.push();
        newChildRef.set({
          "page": "upload",
          "time": Date.now(),
          "action": "open",
          "incoming_g_url_id": incoming_g_url_id,
          "readableTime": readableTime
        });
      } catch (e) {
        console.error(e);
      }
      const auth = firebase.auth();
      // Function to get current user or create anonymous user
      function getCurrentUser() {
        return new Promise((resolve, reject) => {
          // Check if there's already a user signed in
          const unsubscribeAuth = auth.onAuthStateChanged((user) => {
            unsubscribeAuth(); // Stop listening once we have an answer

            if (user) {
              // User is already signed in
              //console.log("User already authenticated:", user.uid);
              resolve(user);
            } else {
              // No user is signed in, create an anonymous user
              //console.log("No user found, creating anonymous user");
              auth.signInAnonymously()
                .then((userCredential) => {
                  // Anonymous user created successfully
                  const anonUser = userCredential.user;
                  //console.log("Anonymous user created:", anonUser.uid);
                  resolve(anonUser);
                })
                .catch((error) => {
                  // Handle errors in creating anonymous user
                  console.error("Error creating anonymous user:", error.code, error.message);
                  reject(error);
                });
            }
          }, reject);
        });
      }
      user = await getCurrentUser();
    })




    function appNameForUrl(str) {
      // console.log("str", str)
      // console.log("package_bundle_id", package_bundle_id)
      var s = str
        .toLowerCase()             // Convert to lowercase
        .replace(/\s+/g, '_')       // Replace spaces with underscores
        .replace(/[^a-z0-9_]/g, ''); // Remove all non a-z, non-digits, except underscore
      if (s.replace(/[_ ]/g, '').length < 2) {
        s = package_bundle_id
          .replace(/com./g, '')
          .replace(/emstell/g, '')
          .replace(/example/g, '')
          .replace(/\./g, '_');
      }
      // console.log("appNameForUrl", s)
      return s;
    }





    function viewJsonInNewTab() {
      const jsonString = encodeURIComponent(JSON.stringify(g_result));
      localStorage.removeItem("hd_time");
      localStorage.removeItem("jsonStore_1");
      localStorage.removeItem("jsonStore_2");
      localStorage.setItem("jsonStore_1", jsonString);
      localStorage.setItem("g_app_name_for_url", g_app_name_for_url);
      const newTab = window.open(`more_info.html`, '_blank');
      if (newTab) {
        newTab.focus();
      } else {
        alert('Please allow popups for this site.');
      }

    }



    function uploadToFirebaseStorage() {
      if (isIos && !pd_zero_accept) {
        var pd = 0
        try {
          pd = g_result["mobileProvision"]["ProvisionedDevices"].length
        } catch (error) {
          console.error(error)
        }
        if (pd == 0) {
          if (confirm("Provisioned Devices : " + pd + ".\nNo UDID added.\nUplaod any way? ")) {
            pd_zero_accept = true;
          } else {
            var redirection = localStorage.getItem('redirection');
            window.location = redirection;
            return
          }
        }
      }


      return new Promise((resolve, reject) => {
        const uploadpercentage = document.querySelector('#uploadpercentage');
        const extension1 = g_file.name.split('.').pop();
        var url = `https://firebasestorage.googleapis.com/v0/b/${g_bucket}/o/${encodeURIComponent("appStorageV2" + "/" + g_app_name_for_url + "/" + g_app_name_for_url + "_" + readableTime + "." + extension1)}`
        const xhr = new XMLHttpRequest();
        xhr.upload.addEventListener('progress', (event) => {

          if (event.lengthComputable) {
            const progress = (event.loaded / event.total) * 100;
            console.log('' + progress.toFixed(0) + '% ');
            if (progress >= 100) {
              uploadpercentage.textContent = 'Done';


            } else {
              uploadpercentage.textContent = '' + progress.toFixed(0) + '%';
            }

          }
        });

        xhr.addEventListener('load', () => {

          if (xhr.status >= 200 && xhr.status < 300) {
            const result = JSON.parse(xhr.responseText);
            const downloadUrl = `${url}?alt=media&token=${result.downloadTokens}`;
            const url_id_text = document.querySelector('#url_id_text');
            const selectedRadio = document.querySelector('input[name="appEnvironment"]:checked');
            if (selectedRadio || incoming_g_url_id !== null)
              url_id_text.textContent = "Preparing...";
            else
              url_id_text.textContent = "Please Select a URL Suffix and Submit...";
            saveFileSizeToDB(g_file.size)
            on_ipa_apk_upload(downloadUrl)
            resolve(result);
          } else {
            const failText = document.querySelector('#failText');
            failText.textContent = "Upload Failed\n" + xhr.status
            reject(new Error(`Upload failed with status: ${xhr.status}`));
          }
        });

        xhr.addEventListener('error', () => {
          const failText = document.querySelector('#failText');
          failText.textContent = 'Network error occurred during upload'
          reject(new Error('Network error occurred during upload'));
        });

        xhr.addEventListener('abort', () => {
          const failText = document.querySelector('#failText');
          failText.textContent = 'Upload aborted'
          reject(new Error('Upload aborted'));
        });

        xhr.open('POST', `${url}?uploadType=media`, true);
        xhr.setRequestHeader('Content-Type', 'application/vnd.android.package-archive');
        xhr.send(g_file);
      });
    }




    async function on_ipa_upload() {
      var plistContent =
        `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>items</key>
  <array>
    <dict>
      <key>assets</key>
      <array>
        <dict>
          <key>kind</key>
          <string>software-package</string>
          <key>url</key>
          <string><![CDATA[YOUR_IPA_URL_HERE]]></string>
        </dict>
      </array>
      <key>metadata</key>
      <dict>
        <key>bundle-identifier</key>
        <string>YOUR_IPA_BUNDLE_ID_HERE</string>
        <key>bundle-version</key>
        <string>YOUR_VERSION_HERE</string>
        <key>kind</key>
        <string>software</string>
        <key>title</key>
        <string>YOUR_IPA_APP_NAME_HERE</string>
        <key>subtitle</key>
        <string></string>
      </dict>
    </dict>
  </array>
</dict>
</plist>`
      plistContent = plistContent.replace("YOUR_IPA_URL_HERE", g_ipa_url)
        .replace("YOUR_VERSION_HERE", g_version)
        .replace("YOUR_IPA_BUNDLE_ID_HERE", package_bundle_id)
        .replace("YOUR_IPA_APP_NAME_HERE", g_app_name)


      if (true) {


        var url = `https://firebasestorage.googleapis.com/v0/b/${g_bucket}/o/${encodeURIComponent("appStorageV2" + "/" + g_app_name_for_url + "/" + g_app_name_for_url + "_" + readableTime + "_manifest" + ".plist")}`

        const headers = {
          'Content-Type': 'application/xml',
        };


        const response = await fetch(url, {
          method: 'POST',
          headers,
          body: plistContent,
        });

        const result = await response.json();

        if (result.error) {
          const failText = document.querySelector('#failText');
          failText.textContent = "Upload Failed\n" + result.error
          console.error("Upload failed:", result.error);
          return;
        }

        const downloadUrl = `${url}?alt=media`;

        //console.log('File available at', downloadUrl);
        g_plist_url = downloadUrl;
        is_apk_plist_done = true;
        on_apk_plist_upload();

      }


    }


    function restrictInput(event) {
      var char = String.fromCharCode(event.which || event.keyCode);
      if (/[a-zA-Z0-9_]/.test(char)) {
        return true;
      } else {
        event.preventDefault();
        return false;
      }
    }

    function sanitizePaste(event) {
      event.preventDefault();

      var clipboardData = event.clipboardData || window.clipboardData;
      var paste = clipboardData.getData('text');

      // Sanitize: keep only a-z, A-Z, 0-9, and underscore
      var sanitized = paste.replace(/[^a-zA-Z0-9_]/g, '');

      // Insert sanitized text at cursor position
      const input = event.target;
      const [start, end] = [input.selectionStart, input.selectionEnd];
      const currentValue = input.value;

      input.value = currentValue.slice(0, start) + sanitized + currentValue.slice(end);

      // Move cursor to the end of the inserted text
      const newCursorPos = start + sanitized.length;
      input.setSelectionRange(newCursorPos, newCursorPos);
    }


    function urlSuffixCommaSeperated(longString, smallString) {
      return [...new Set((longString ? `${longString},${smallString}` : smallString).split(','))].filter(item => item.trim() !== '').join(',');
    }



    function addDynamicRadioOptions(longCommaString) {
      const optionsArray = (longCommaString && typeof longCommaString === 'string')
        ? longCommaString.split(',')
        : [];


      try {
        if (optionsArray.includes(g_app_name_for_url)) {
          document.getElementById('customInput').value = g_app_name_for_url + "QA";
        }
      } catch (error) {

      }






      const dynamicRadioContainer = document.getElementById('dynamicRadioOptions');

      if (optionsArray.length >= 100) {
        const dynamicRadioOptions = document.getElementById('customOptionDIV');
        if (dynamicRadioOptions) {
          dynamicRadioOptions.style.display = 'none';
        }
      }

      optionsArray.forEach((option, index) => {
        const trimmedOption = option.trim();
        if (trimmedOption) {
          const radioDiv = document.createElement('div');
          radioDiv.classList.add('radioOption');

          const radioInput = document.createElement('input');
          radioInput.type = 'radio';
          radioInput.id = `dynamicOption${index}`;
          radioInput.name = 'appEnvironment';
          radioInput.value = trimmedOption;
          radioInput.onclick = setGURLID; // Assuming setGURLID is defined elsewhere

          const radioLabel = document.createElement('label');
          radioLabel.setAttribute('for', `dynamicOption${index}`);
          radioLabel.textContent = trimmedOption;

          radioDiv.appendChild(radioInput);
          radioDiv.appendChild(radioLabel);
          dynamicRadioContainer.appendChild(radioDiv);
        }
      });
    }


    function refreshCustomInput() {

      var url_id = makeid(4);
      console.log(url_id);
      firebase.database().ref("/app_links/" + url_id).get().then((snapshot) => {
        if (snapshot.exists()) {
          refreshCustomInput()
        } else {
          const customInput = document.getElementById('customInput');
          customInput.value = url_id;
          document.getElementById("customOption").checked = true;

        }
      }).catch((error) => {
        console.error(error);
      });





    }






    async function findBestBucket() {
      const snapshot = await firebase.database().ref("/storage_buckets").once("value");
      const data = snapshot.val();

      const MAX_BYTES = 4.8 * 1024 * 1024 * 1024; // 4.8 GB in bytes

      let bestKey = null;
      let leastUsed = Infinity;
      var totalSpace=Object.entries(data).length*MAX_BYTES
      var usedSpace=0.0

      for (const [key, value] of Object.entries(data)) {
        if (typeof value === "number" && value !== -1 && value < MAX_BYTES) {
          usedSpace+=value
          if (value < leastUsed) {
            leastUsed = value;
            bestKey = key;
          }
        }
      }
      var availableSpace=totalSpace-usedSpace
      const availableSpacePercentage = ((usedSpace / totalSpace) * 100).toFixed(0);
     var text= "Available Space : " +  (availableSpace / (1024 * 1024 * 1024)).toFixed(2)+" Gb / "+(totalSpace / (1024 * 1024 * 1024)).toFixed(2) +" Gb ("+availableSpacePercentage+"% Used)";
     document.getElementById('availableSpace').innerText=text;
     //console.log(text)
     if (bestKey) {
        return bestKey.replace(/_/g, ".");
      }

      return null; // or throw an error, or handle no suitable bucket
    }


    async function saveFileSizeToDB(fileSize) {
      try {
        const ref = firebase.database().ref("/storage_buckets/" + g_bucket.replace(/\./g, "_"));
        const snapshot = await ref.once("value");
        const current = snapshot.val() || 0;
        await ref.set(current + fileSize);
        //console.log("File Size :", `${fileSize / (1024 * 1024)} Mb ${g_bucket} ||| Used Space ${(current+fileSize) / (1024 * 1024* 1024)} Gb   ${fileSize} ${current+fileSize}`)
      } catch (error) {
        console.error(error);
      }
    }


  </script>
</body>

</html>